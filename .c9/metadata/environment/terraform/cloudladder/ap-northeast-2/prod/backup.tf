{"filter":false,"title":"backup.tf","tooltip":"/terraform/cloudladder/ap-northeast-2/prod/backup.tf","undoManager":{"mark":7,"position":7,"stack":[[{"start":{"row":0,"column":0},"end":{"row":101,"column":1},"action":"insert","lines":["data \"terraform_remote_state\" \"s3\" {","  backend = \"s3\"","  config = {","    bucket = \"cloudwave-cloudladder-tfstate\"","    key = \"infra/terraform.tfstate\"","    region = \"ap-northeast-2\"","  }","}","","resource \"aws_iam_role\" \"db_backup\" {","  name = \"db_backup\"","","  assume_role_policy = jsonencode({","    Version = \"2012-10-17\"","    Statement = [","      {","        Action = \"sts:AssumeRole\"","        Effect = \"Allow\"","        Sid    = \"\"","        Principal = {","          Service = \"export.rds.amazonaws.com\"","        }","      },","    ]","  })","}","","data \"aws_iam_policy_document\" \"db_backup\" {","  statement {","    actions = [","      \"s3:ListAllMyBuckets\",","    ]","    resources = [","      \"*\"","    ]","  }","  statement {","    actions = [","      \"s3:GetBucketLocation\",","      \"s3:ListBucket\",","    ]","    resources = [","      data.terraform_remote_state.s3.outputs.s3_backup_arn","    ]","  }","  statement {","    actions = [","      \"s3:GetObject\",","      \"s3:PutObject\",","      \"s3:DeleteObject\",","    ]","    resources = [","      \"${data.terraform_remote_state.s3.outputs.s3_backup_arn}/*\"","    ]","  }","}","","resource \"aws_iam_policy\" \"db_backup\" {","  name   = \"db_backup\"","  policy = data.aws_iam_policy_document.db_backup.json","}","","resource \"aws_iam_role_policy_attachment\" \"db_backup\" {","  role       = aws_iam_role.db_backup.name","  policy_arn = aws_iam_policy.db_backup.arn","}","","resource \"aws_kms_key\" \"db_backup\" {","  deletion_window_in_days = 10","}","","resource \"aws_db_snapshot\" \"db_backup_users\" {","  db_instance_identifier = aws_db_instance.mysql_users.identifier","  db_snapshot_identifier = \"users-backup\"","}","","resource \"aws_rds_export_task\" \"db_backup_users\" {","  export_task_identifier = \"ap-northeast-2-db-backup-users\"","  source_arn             = aws_db_snapshot.db_backup_users.db_snapshot_arn","  s3_bucket_name         = \"ap-northeast-2-cloudladder-backup\"","  iam_role_arn           = aws_iam_role.db_backup.arn","  kms_key_id             = aws_kms_key.db_backup.arn","","  export_only = [\"database\"]","  s3_prefix   = \"users/db_backup\"","}","","resource \"aws_db_snapshot\" \"db_backup_orders\" {","  db_instance_identifier = aws_db_instance.mysql_orders.identifier","  db_snapshot_identifier = \"orders-backup\"","}","","resource \"aws_rds_export_task\" \"db_backup_orders\" {","  export_task_identifier = \"ap-northeast-2-db-backup-orders\"","  source_arn             = aws_db_snapshot.db_backup_orders.db_snapshot_arn","  s3_bucket_name         = \"ap-northeast-2-cloudladder-backup\"","  iam_role_arn           = aws_iam_role.db_backup.arn","  kms_key_id             = aws_kms_key.db_backup.arn","","  export_only = [\"database\"]","  s3_prefix   = \"orders/db_backup\"","}"],"id":1}],[{"start":{"row":77,"column":31},"end":{"row":77,"column":40},"action":"remove","lines":["northeast"],"id":2},{"start":{"row":77,"column":31},"end":{"row":77,"column":32},"action":"insert","lines":["c"]},{"start":{"row":77,"column":32},"end":{"row":77,"column":33},"action":"insert","lines":["l"]},{"start":{"row":77,"column":33},"end":{"row":77,"column":34},"action":"insert","lines":["o"]},{"start":{"row":77,"column":34},"end":{"row":77,"column":35},"action":"insert","lines":["u"]},{"start":{"row":77,"column":35},"end":{"row":77,"column":36},"action":"insert","lines":["d"]}],[{"start":{"row":77,"column":36},"end":{"row":77,"column":37},"action":"insert","lines":["w"],"id":3},{"start":{"row":77,"column":37},"end":{"row":77,"column":38},"action":"insert","lines":["a"]},{"start":{"row":77,"column":38},"end":{"row":77,"column":39},"action":"insert","lines":["v"]},{"start":{"row":77,"column":39},"end":{"row":77,"column":40},"action":"insert","lines":["e"]}],[{"start":{"row":93,"column":31},"end":{"row":93,"column":40},"action":"remove","lines":["northeast"],"id":4},{"start":{"row":93,"column":31},"end":{"row":93,"column":40},"action":"insert","lines":["cloudwave"]}],[{"start":{"row":89,"column":28},"end":{"row":89,"column":37},"action":"insert","lines":["cloudwave"],"id":5}],[{"start":{"row":89,"column":37},"end":{"row":89,"column":38},"action":"insert","lines":["-"],"id":6}],[{"start":{"row":73,"column":28},"end":{"row":73,"column":37},"action":"insert","lines":["cloudwave"],"id":7}],[{"start":{"row":73,"column":37},"end":{"row":73,"column":38},"action":"insert","lines":["-"],"id":8}]]},"ace":{"folds":[],"scrolltop":1225,"scrollleft":0,"selection":{"start":{"row":73,"column":38},"end":{"row":73,"column":38},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":60,"state":"start","mode":"ace/mode/terraform"}},"timestamp":1709021754889,"hash":"534a66bf59d5aa2b04bd2a952226a05faa7234bb"}